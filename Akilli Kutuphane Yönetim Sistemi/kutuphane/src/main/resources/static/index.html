<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkÄ±llÄ± KÃ¼tÃ¼phane Sistemi</title>
    <style>
        :root { --admin-color: #c0392b; --student-color: #2980b9; --bg-color: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background-color: var(--bg-color); color: #333; }
        nav { background: #2c3e50; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .container { padding: 20px; max-width: 1200px; margin: auto; }
        section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        
        /* Tablo Stilleri */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #2c3e50; }
        tr:hover { background-color: #fcfcfc; }

        /* Butonlar */
        button { cursor: pointer; padding: 8px 16px; border: none; border-radius: 4px; font-weight: 500; transition: 0.3s; }
        .btn-logout { background: #e74c3c; color: white; }
        .btn-primary { background: var(--student-color); color: white; }
        .btn-admin { background: var(--admin-color); color: white; margin-right: 5px; margin-bottom: 5px; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #c0392b; color: white; }
        
        /* Formlar */
        .form-group { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 180px; }
        .hidden { display: none; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; }
        .badge-red { background: #fadbd8; color: #e74c3c; }
        .badge-green { background: #d4efdf; color: #27ae60; }
    </style>
</head>
<body>

<nav>
    <div style="font-size: 1.4rem; font-weight: bold;">ðŸ“š AkÄ±llÄ± KÃ¼tÃ¼phane</div>
    <div>
        <span id="welcomeMsg" style="margin-right: 20px; font-weight: 500;"></span>
        <button class="btn-logout" onclick="logout()">GÃ¼venli Ã‡Ä±kÄ±ÅŸ</button>
    </div>
</nav>

<div class="container">
    
    <section id="adminPanel" class="hidden">
        <h2 style="color: var(--admin-color);">YÃ¶netici Paneli</h2>
        <div class="form-group">
            <button class="btn-admin" onclick="toggleArea('kitapForm')">+ Kitap Ekle</button>
            <button class="btn-admin" onclick="toggleArea('yazarForm')">+ Yazar Ekle</button>
            <button class="btn-admin" onclick="toggleArea('kategoriForm')">+ Kategori Ekle</button>
            <button class="btn-admin" onclick="listAllUsers()">KullanÄ±cÄ±larÄ± YÃ¶net</button>
        </div>

        <div id="kitapForm" class="hidden" style="background: #fff5f5; padding: 15px; border-radius: 5px; border-left: 4px solid var(--admin-color);">
            <h3>Yeni Kitap KaydÄ±</h3>
            <div class="form-group">
                <input type="text" id="k_ad" placeholder="Kitap AdÄ±">
                <input type="number" id="k_stok" placeholder="Toplam Stok">
                <select id="sel_yazar"><option value="">Yazar SeÃ§iniz</option></select>
                <select id="sel_kat"><option value="">Kategori SeÃ§iniz</option></select>
                <button class="btn-success" onclick="saveKitap()">Sisteme Kaydet</button>
            </div>
        </div>

        <div id="yazarForm" class="hidden" style="background: #fff5f5; padding: 15px; border-radius: 5px; margin-top: 10px;">
            <h3>Yazar Ekle</h3>
            <div class="form-group">
                <input type="text" id="y_ad" placeholder="Yazar AdÄ±">
                <input type="text" id="y_soyad" placeholder="Yazar SoyadÄ±">
                <button class="btn-success" onclick="saveYazar()">YazarÄ± Kaydet</button>
            </div>
        </div>

        <div id="kategoriForm" class="hidden" style="background: #fff5f5; padding: 15px; border-radius: 5px; margin-top: 10px;">
            <h3>Kategori Ekle</h3>
            <div class="form-group">
                <input type="text" id="kat_ad" placeholder="Kategori AdÄ±">
                <button class="btn-success" onclick="saveKategori()">Kategoriyi Kaydet</button>
            </div>
        </div>

        <div id="adminSections" style="margin-top: 30px;">
            <h3 style="color: #2c3e50;">ðŸ“‹ TÃ¼m Ã–dÃ¼nÃ§ AlÄ±nanlar</h3>
            <table>
                <thead>
                    <tr>
                        <th>Ã–ÄŸrenci</th>
                        <th>Kitap AdÄ±</th>
                        <th>VeriliÅŸ</th>
                        <th>Son Teslim</th>
                        <th>Durum</th>
                    </tr>
                </thead>
                <tbody id="adminOduncTable"></tbody>
            </table>

            <h3 style="color: #2c3e50; margin-top: 30px;">ðŸ’° Genel Ceza Listesi</h3>
            <table>
                <thead>
                    <tr>
                        <th>Ã–ÄŸrenci</th>
                        <th>Miktar</th>
                        <th>Durum</th>
                        <th>Ã–deme</th>
                    </tr>
                </thead>
                <tbody id="adminCezaTable"></tbody>
            </table>

            <div id="userListArea" style="margin-top: 30px;"></div>
        </div>
    </section>

    <section id="studentPanel" class="hidden">
        <h2 style="color: var(--student-color);">Ã–ÄŸrenci MenÃ¼sÃ¼</h2>
        <button class="btn-primary" onclick="loadMyBorrows()">Ã–dÃ¼nÃ§ AldÄ±klarÄ±m</button>
        <button class="btn-primary" onclick="loadMyFines()">CezalarÄ±m</button>
        <div id="studentDisplayArea" style="margin-top: 20px;"></div>
    </section>

    <section>
        <h2>KÃ¼tÃ¼phane ArÅŸivi</h2>
        <div class="form-group">
            <input type="text" id="searchBox" placeholder="Kitap veya yazar ara..." onkeyup="searchKitap()" style="width: 100%;">
        </div>
        <table id="booksTable">
            <thead>
                <tr>
                    <th>Kitap AdÄ±</th>
                    <th>Yazar</th>
                    <th>Kategori</th>
                    <th>Mevcut Stok</th>
                    <th>Ä°ÅŸlem</th>
                </tr>
            </thead>
            <tbody id="booksTableBody"></tbody>
        </table>
    </section>
</div>

<script>
    const token = localStorage.getItem('jwtToken');
    let currentUser = null;

    // 1. UYGULAMA BAÅžLATMA
    async function init() {
        if (!token) { window.location.href = 'login.html'; return; }

        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const email = payload.sub;

            const response = await fetch(`/kullanici/eposta?eposta=${email}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (!response.ok) throw new Error("KullanÄ±cÄ± bulunamadÄ±");
            
            currentUser = await response.json();
            document.getElementById('welcomeMsg').innerText = `ðŸ‘¤ ${currentUser.kullaniciAd} ${currentUser.kullaniciSoyad} (${currentUser.rol})`;
            
            if(currentUser.rol === 'admin') {
                document.getElementById('adminPanel').classList.remove('hidden');
                loadAdminData();
                loadAllOduncAdmin(); // Yeni
                loadAllFinesAdmin(); // Yeni
            } else {
                document.getElementById('studentPanel').classList.remove('hidden');
            }
            loadBooks();

        } catch (error) {
            console.error("GiriÅŸ hatasÄ±:", error);
            logout();
        }
    }

    // 2. KÄ°TAPLARI LÄ°STELE
    function loadBooks() {
        fetch('/kitap', { headers: { 'Authorization': 'Bearer ' + token } })
        .then(res => res.json())
        .then(data => {
            const body = document.getElementById('booksTableBody');
            body.innerHTML = '';
            data.forEach(book => {
                body.innerHTML += `
                    <tr>
                        <td><strong>${book.kitapAd}</strong></td>
                        <td>${book.yazar.yazarAd} ${book.yazar.yazarSoyad}</td>
                        <td>${book.kategori.kategoriAd}</td>
                        <td>${book.mevcutStok} / ${book.toplamStok}</td>
                        <td>
                            <button class="btn-primary" onclick="oduncAl(${book.kitapId})" 
                                ${book.mevcutStok <= 0 ? 'disabled style="background:gray"' : ''}>
                                ${book.mevcutStok <= 0 ? 'TÃ¼kendi' : 'Ã–dÃ¼nÃ§ Al'}
                            </button>
                        </td>
                    </tr>`;
            });
        });
    }

    // 3. ADMIN: TÃœM Ã–DÃœNÃ‡LERÄ° GETÄ°R
    async function loadAllOduncAdmin() {
        const res = await fetch('/odunc/admin/hepsi', { headers: { 'Authorization': 'Bearer ' + token } });
        if(res.ok) {
            const data = await res.json();
            const body = document.getElementById('adminOduncTable');
            body.innerHTML = data.map(o => `
                <tr>
                    <td>${o.kullanici.kullaniciAd} ${o.kullanici.kullaniciSoyad}</td>
                    <td>${o.kitap.kitapAd}</td>
                    <td>${formatDate(o.oduncTarihi)}</td>
                    <td>${formatDate(o.planlananIadeTarihi)}</td>
                    <td><span class="badge ${o.durum === 'oduncte' ? 'badge-red' : 'badge-green'}">${o.durum}</span></td>
                </tr>
            `).join('');
        }
    }

    // 4. ADMIN: TÃœM CEZALARI GETÄ°R
    async function loadAllFinesAdmin() {
        const res = await fetch('/ceza', { headers: { 'Authorization': 'Bearer ' + token } });
        if(res.ok) {
            const data = await res.json();
            const body = document.getElementById('adminCezaTable');
            body.innerHTML = data.map(c => `
                <tr>
                    <td>${c.oduncAlma.kullanici.kullaniciAd}</td>
                    <td>${c.cezaMiktari} TL</td>
                    <td>${c.cezaMiktari > 0 ? 'ðŸ”´ Gecikme' : 'âœ… Temiz'}</td>
                    <td>${c.odemeDurumu}</td>
                </tr>
            `).join('');
        }
    }

    // 5. ADMIN: KULLANICI YÃ–NETÄ°MÄ°
    function listAllUsers() {
        fetch('/kullanici', { headers: { 'Authorization': 'Bearer ' + token } })
        .then(res => res.json())
        .then(data => {
            let html = `<h3>ðŸ‘¥ Sistemdeki KullanÄ±cÄ±lar</h3><table><thead><tr><th>Ad Soyad</th><th>E-posta</th><th>Rol</th><th>Ä°ÅŸlem</th></tr></thead><tbody>`;
            data.forEach(u => {
                html += `<tr>
                    <td>${u.kullaniciAd} ${u.kullaniciSoyad}</td>
                    <td>${u.kullaniciEposta}</td>
                    <td>${u.rol}</td>
                    <td><button class="btn-danger" onclick="deleteUser(${u.kullaniciId})">Sil</button></td>
                </tr>`;
            });
            document.getElementById('userListArea').innerHTML = html + "</tbody></table>";
        });
    }

    function deleteUser(id) {
        if(confirm("Bu kullanÄ±cÄ±yÄ± silmek istediÄŸinize emin misiniz?")) {
            fetch(`/kullanici/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } })
            .then(() => listAllUsers());
        }
    }

    // 6. Ã–ÄžRENCÄ° Ä°ÅžLEMLERÄ° (Ã–dÃ¼nÃ§, Ä°ade, Ceza)
    function oduncAl(bookId) {
        const oduncData = {
            durum: 'oduncte',
            oduncTarihi: new Date().toISOString().split('T')[0],
            planlananIadeTarihi: new Date(Date.now() + 14*24*60*60*1000).toISOString().split('T')[0],
            kullanici: { kullaniciId: currentUser.kullaniciId },
            kitap: { kitapId: bookId }
        };
        fetch('/odunc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify(oduncData)
        }).then(res => {
            if(res.ok) { alert("BaÅŸarÄ±lÄ±!"); loadBooks(); if(currentUser.rol === 'admin') loadAllOduncAdmin(); }
        });
    }

    function loadMyBorrows() {
        fetch(`/odunc/kullanici/${currentUser.kullaniciId}`, { headers: { 'Authorization': 'Bearer ' + token } })
        .then(res => res.json())
        .then(data => {
            let html = `<h3>Ã–dÃ¼nÃ§ GeÃ§miÅŸim</h3><table><thead><tr><th>Kitap</th><th>Durum</th><th>Son Ä°ade</th><th>Ä°ÅŸlem</th></tr></thead><tbody>`;
            data.forEach(o => {
                html += `<tr>
                    <td>${o.kitap.kitapAd}</td>
                    <td><span class="badge ${o.durum === 'oduncte' ? 'badge-red' : 'badge-green'}">${o.durum}</span></td>
                    <td>${formatDate(o.planlananIadeTarihi)}</td>
                    <td>${o.durum === 'oduncte' ? `<button class="btn-success" onclick="iadeEt(${o.oduncId})">Ä°ade Et</button>` : 'TamamlandÄ±'}</td>
                </tr>`;
            });
            document.getElementById('studentDisplayArea').innerHTML = html + "</tbody></table>";
        });
    }

    function loadMyFines() {
        fetch('/ceza', { headers: { 'Authorization': 'Bearer ' + token } })
        .then(res => res.json())
        .then(data => {
            const myFines = data.filter(c => c.oduncAlma.kullanici.kullaniciId === currentUser.kullaniciId);
            let html = `<h3>CezalarÄ±m</h3><table><thead><tr><th>Kitap</th><th>Miktar</th><th>Durum</th></tr></thead><tbody>`;
            myFines.forEach(c => {
                html += `<tr><td>${c.oduncAlma.kitap.kitapAd}</td><td>${c.cezaMiktari} TL</td><td>${c.odemeDurumu}</td></tr>`;
            });
            document.getElementById('studentDisplayArea').innerHTML = html + "</tbody></table>";
        });
    }

    function iadeEt(id) {
        fetch(`/odunc/${id}/iade`, { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } })
        .then(res => { if(res.ok) { alert("Ä°ade Edildi"); loadMyBorrows(); loadBooks(); } });
    }

    // 7. YÃ–NETÄ°CÄ°: KAYIT Ä°ÅžLEMLERÄ°
    function saveKitap() {
        const payload = {
            kitapAd: document.getElementById('k_ad').value,
            toplamStok: parseInt(document.getElementById('k_stok').value),
            mevcutStok: parseInt(document.getElementById('k_stok').value),
            yazar: { yazarId: parseInt(document.getElementById('sel_yazar').value) },
            kategori: { kategoriId: parseInt(document.getElementById('sel_kat').value) }
        };
        fetch('/kitap', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify(payload)
        }).then(() => location.reload());
    }

    function saveYazar() {
        const payload = { yazarAd: document.getElementById('y_ad').value, yazarSoyad: document.getElementById('y_soyad').value };
        fetch('/yazar', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(payload) })
        .then(() => { alert("Yazar eklendi"); loadAdminData(); });
    }

    function saveKategori() {
        const payload = { kategoriAd: document.getElementById('kat_ad').value };
        fetch('/kategori', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(payload) })
        .then(() => { alert("Kategori eklendi"); loadAdminData(); });
    }

    function loadAdminData() {
        fetch('/yazar', { headers: { 'Authorization': 'Bearer ' + token } }).then(res => res.json()).then(data => {
            const s = document.getElementById('sel_yazar'); s.innerHTML = '<option value="">Yazar SeÃ§iniz</option>';
            data.forEach(y => s.innerHTML += `<option value="${y.yazarId}">${y.yazarAd} ${y.yazarSoyad}</option>`);
        });
        fetch('/kategori', { headers: { 'Authorization': 'Bearer ' + token } }).then(res => res.json()).then(data => {
            const s = document.getElementById('sel_kat'); s.innerHTML = '<option value="">Kategori SeÃ§iniz</option>';
            data.forEach(k => s.innerHTML += `<option value="${k.kategoriId}">${k.kategoriAd}</option>`);
        });
    }

    // YARDIMCI FONKSÄ°YONLAR
    function formatDate(isoDate) {
        if(!isoDate) return "-";
        const date = new Date(isoDate);
        return date.toLocaleDateString('tr-TR');
    }
    function toggleArea(id) { document.getElementById(id).classList.toggle('hidden'); }
    function logout() { localStorage.removeItem('jwtToken'); window.location.href = 'login.html'; }

    init();
</script>

</body>
</html>




